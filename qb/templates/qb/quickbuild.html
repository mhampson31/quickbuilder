{% load qb_extras %}

    <header class="row">
        <span class="col font-weight-light {{ qb.threat|threatbar }}">{{ qb.threat|threatbar|safe }}</span>
        <span class="col font-weight-light text-right">#{{ qb.id }}</span>
    </header>

    <section class="quickbuild border rounded">
    {% for build in qb.build_set.all %}
        <section class="container">

            {% if not forloop.first %}
                <div class="text-center">Ship {{ forloop.counter }}</div>
            {% endif %}

            <div class="row"> <!-- row 1 -->
                <div class="col-md-8">
                    <h5>{{build.pilot}} ({{build.pilot.ship}})</h5>
                </div>

                <div class="col text-right">
                    {% for attack in build.pilot.ship.shipattack_set.all %}
                        <span class="icon attack">{{ attack.display_name|iconize }}</span>
                    {% endfor %}

                        <span class="icon">{{ "agility"|get_icon:"agility" }} {{build.agility}}</span>

                    {% if build.shields %}
                        <span class="icon">{{ "shield"|get_icon:"shields" }} {{build.shields}}</span>
                    {% endif %}

                        <span class="icon">{{ "hull"|get_icon:"hull" }} {{build.hull}}</span>

                    {% if build.force %}
                        <span class="icon">{{ "forcecharge"|get_icon:"force" }} {{build.force}}</span>
                    {% endif %}

                    {% if build.pilot.charge %}
                        <span class="icon">{{ "charge"|get_icon:"charge" }} {{build.pilot.charge}}
                        {% if build.pilot.charge_regen %} {{"recurring"|get_icon:"charge"}}{% endif %}</span>
                    {% endif %}
                </div>

            </div> <!-- end row 1 -->

            <div class="row"> <!-- row 2 -->

                <div class="col-md-5">
                    <h5>Initiative {{ build.pilot.initiative }}</h5>
                </div>


                <div class="col text-right"> <!-- action sidebar -->
                    {% for action in build.action_bar %}
                        <span>{{action.display_name|safe}}</span>
                    {% endfor %}
                </div>

            </div> <!-- end row 2 -->

            <section> <!-- upgrade group -->
                {% if build.pilot.ability %}
                <div class="row upgrade">
                    <div class="col-md-3 text-nowrap">{{build.pilot.display_name}}</div>

                    <div class="col ability">
                        <span>{{ build.pilot.ability|iconize|safe }}</span>
                        {% if build.pilot.charge %}
                            <div>
                                {{ "charge"|get_icon:"charge" }}
                                {{ build.pilot.charge }}{% if build.pilot.charge_regen %}{{ "recurring"|get_icon }}{% endif %}
                            </div>
                        {% endif %}
                    </div>
                </div>

                {% with condition=build.pilot.condition %}
                {% if condition %}
                <div class="row condition">
                    <div class="col-md-3">
                        {{ condition.name }}
                    </div>

                    <div class="col">
                        {{ condition.effect }}
                    </div>
                </div>
                {% endif %}
                {% endwith %}

                {% endif %}

                {% if build.pilot.ship.ability_title %}
                <div class="row upgrade">
                    <div class=" col-md-3 text-nowrap">{{ build.pilot.ship.ability_title }} {{ build.pilot.ship.icon }}</div>
                    <div class="col ability">{{ build.pilot.ship.ability|iconize }}</div>
                </div>
                {% endif %}

                {% for upgrade in build.upgrades.all %}
                <div class="row upgrade">
                    <div class="col-md-3 text-nowrap ability" >
                        {{upgrade}}
                        {{upgrade.get_slot_display|get_icon}}
                        {% if upgrade.slot2 %}
                        {{upgrade.get_slot_display|get_icon}}
                        {% endif %}
                    </div>

                    <div class="col">
                        {% if upgrade.special_attack %}
                            <div>{{ upgrade.special_attack.display_name|iconize }}</div>
                        {% endif %}

                        {% if upgrade.actions %}
                            <div>
                                {% for action in upgrade.upgradeaction_set.all %}
                                {{ action.display_name }}
                                {% endfor %}
                            </div>
                        {% endif %}

                        {% if upgrade.grants %}
                            <div>{{ upgrade.grants|iconize }}</div>
                        {% endif %}

                        <span class="ability">{{ upgrade.ability|iconize }}</span>

                        {% if upgrade.charge %}
                            <div>
                                {{ "charge"|get_icon:"charge" }}
                                {{upgrade.charge}}{% if upgrade.charge_regen %} {{ "recurring"|get_icon }}{% endif %}
                            </div>
                        {% endif %}

                    </div>
                </div>

                {% with side2=upgrade.side2 %}
                {% if side2 %}
                <div class="row">
                    <div class="col-md-3 text-nowrap ability">
                        {{side2}}
                        {{side2.get_slot_display|get_icon}}
                        {% if side2.slot2 %}
                        {{side2.get_slot_display|get_icon}}
                        {% endif %}
                    </div>

                    <div class="col side2">
                        {% if side2.special_attack %}
                            <div>{{ side2.special_attack.display_name|iconize }}</div>
                        {% endif %}

                        {% if side2.actions %}
                            <div>
                                {% for action in side2.upgradeaction_set.all %}
                                {{ action.display_name }}
                                {% endfor %}
                            </div>
                        {% endif %}

                        {% if side2.grants %}
                            <div>{{ side2.grants|iconize }}</div>
                        {% endif %}

                        <span class="ability">{{ side2.ability|iconize }}</span>

                        {% if side2.charge %}
                            <div>
                                {{ "charge"|get_icon:"charge" }}
                                {{side2.charge}}{% if side2.charge_regen %} {{ "recurring"|get_icon }}{% endif %}
                            </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %} <!-- side2 -->
                {% endwith %}

                {% with condition=upgrade.condition %}
                {% if condition %}
                <div class="row condition">
                    <div class="col-md-3">
                        {{ condition.name }}
                    </div>

                    <div class="col">
                        {{ condition.effect }}
                    </div>
                </div>
                {% endif %}
                {% endwith %}

                {% endfor %} <!-- end upgrades -->

                {% if not build.pilot.ability and not build.pilot.ship.ability and not build.upgrades %}
                <div class="col">
                    <span><i>No special abilities.</i></span>
                </div>
                {% endif %}

            </section>

        </section>

        <!-- end build -->
    {% endfor %} <!-- end quickbuild -->

    </section>
